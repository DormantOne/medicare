<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Provider Procedure Lookup</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <style>
    /* ... (keeping existing styles) ... */
    
    /* Additional styles for enhanced filtering */
    .filter-section {
      background-color: #f5f5f5;
      padding: 15px;
      border-radius: 4px;
      margin-bottom: 20px;
    }
    
    .name-inputs {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-bottom: 15px;
    }

    .location-filter {
      display: flex;
      gap: 15px;
      margin-bottom: 15px;
    }

    .location-option {
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .provider-card {
      background: white;
      padding: 15px;
      margin: 10px 0;
      border-radius: 4px;
      border: 1px solid #ddd;
      cursor: pointer;
      transition: background-color 0.2s;
    }

    .provider-card:hover {
      background-color: #f8f9fa;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Provider Procedure Lookup</h1>

    <!-- Search Type Selection -->
    <div class="search-options">
      <label>
        <input type="radio" name="searchType" value="npi" checked /> Search by NPI
      </label>
      <label>
        <input type="radio" name="searchType" value="name" /> Search by Name
      </label>
    </div>

    <!-- NPI Search -->
    <div id="npiSearch" class="input-group">
      <label for="npiInput">NPI Number</label>
      <input type="text" id="npiInput" placeholder="Enter 10-digit NPI number" maxlength="10" />
    </div>

    <!-- Name Search -->
    <div id="nameSearch" class="input-group" style="display: none;">
      <div class="name-inputs">
        <div>
          <label for="lastNameInput">Last Name</label>
          <input type="text" id="lastNameInput" placeholder="Enter last name" />
        </div>
        <div>
          <label for="firstNameInput">First Name (optional)</label>
          <input type="text" id="firstNameInput" placeholder="Enter first name" />
        </div>
      </div>
    </div>

    <!-- Location Filter -->
    <div class="filter-section">
      <label>Location Filter:</label>
      <div class="location-filter">
        <label class="location-option">
          <input type="radio" name="location" value="all" checked /> 
          All Locations
        </label>
        <label class="location-option">
          <input type="radio" name="location" value="shadyside" /> 
          Shadyside (15232)
        </label>
        <label class="location-option">
          <input type="radio" name="location" value="presby" /> 
          Presbyterian (15213)
        </label>
      </div>
    </div>

    <button id="lookupButton" onclick="lookupProvider()">Search</button>

    <div id="loading" class="loading">
      <div class="progress-bar">
        <div id="progress-fill" class="progress-bar-fill"></div>
      </div>
      <div id="progress-text"></div>
    </div>

    <div id="providerList" class="provider-list"></div>
    <div id="providerInfo" class="provider-info"></div>
    <div id="results"></div>
  </div>

  <script>
    // Configuration
    const GITHUB_BASE_URL_FILES = 'https://raw.githubusercontent.com/DormantOne/medicare/split_files/';
    const GITHUB_BASE_URL_INDEX = 'https://raw.githubusercontent.com/DormantOne/medicare/main/';

    // Updated for expanded index files
    const indexFiles = [
      'expanded_npi_index_01_1003000126-1093087314.json',
      'expanded_npi_index_02_1093087504-1184088171.json',
      'expanded_npi_index_03_1184088189-1275256612.json',
      'expanded_npi_index_04_1275257784-1366438699.json',
      'expanded_npi_index_05_1366438715-1457407470.json',
      'expanded_npi_index_06_1457407488-1548359466.json',
      'expanded_npi_index_07_1548359474-1639298656.json',
      'expanded_npi_index_08_1639298789-1720286552.json',
      'expanded_npi_index_09_1720286578-1811504210.json',
      'expanded_npi_index_10_1811504319-1902846207.json',
      'expanded_npi_index_11_1902846215-1992817613.json',
      'expanded_npi_index_12_1992817647-1992999874.json'
    ];

    // DOM Elements
    const searchTypeInputs = document.querySelectorAll('input[name="searchType"]');
    const npiSearchDiv = document.getElementById('npiSearch');
    const nameSearchDiv = document.getElementById('nameSearch');
    const npiInput = document.getElementById('npiInput');
    const lastNameInput = document.getElementById('lastNameInput');
    const firstNameInput = document.getElementById('firstNameInput');
    const lookupButton = document.getElementById('lookupButton');
    const loadingDiv = document.getElementById('loading');
    const progressFill = document.getElementById('progress-fill');
    const progressText = document.getElementById('progress-text');
    const providerList = document.getElementById('providerList');
    const providerInfoDiv = document.getElementById('providerInfo');
    const resultsDiv = document.getElementById('results');

    // Event Listeners
    searchTypeInputs.forEach(radio => {
      radio.addEventListener('change', function() {
        const isNPI = this.value === 'npi';
        npiSearchDiv.style.display = isNPI ? 'block' : 'none';
        nameSearchDiv.style.display = isNPI ? 'none' : 'block';
        updateButtonState();
      });
    });

    function updateButtonState() {
      const searchType = document.querySelector('input[name="searchType"]:checked').value;
      if (searchType === 'npi') {
        lookupButton.disabled = !/^\d{10}$/.test(npiInput.value);
      } else {
        lookupButton.disabled = lastNameInput.value.trim().length < 2;
      }
    }

    [npiInput, lastNameInput, firstNameInput].forEach(input => {
      input.addEventListener('input', updateButtonState);
    });

    async function lookupProvider() {
      resetUI();
      const searchType = document.querySelector('input[name="searchType"]:checked').value;
      const locationFilter = document.querySelector('input[name="location"]:checked').value;

      if (searchType === 'npi') {
        await lookupByNPI(npiInput.value.trim(), locationFilter);
      } else {
        await lookupByName(
          lastNameInput.value.trim(),
          firstNameInput.value.trim(),
          locationFilter
        );
      }
    }

    async function lookupByName(lastName, firstName, location) {
      const matches = await findProviders(lastName, firstName, location);
      displayResults(matches);
    }

    async function findProviders(lastName, firstName, location) {
      const matches = [];
      const lastNameUpper = lastName.toUpperCase();
      const firstNameUpper = firstName.toUpperCase();

      for (const fileName of indexFiles) {
        progressText.textContent = `Searching ${fileName}...`;
        try {
          const response = await fetch(`${GITHUB_BASE_URL_INDEX}${fileName}`);
          if (!response.ok) continue;

          const data = await response.json();
          
          for (const [npi, provider] of Object.entries(data)) {
            // Apply location filter
            if (location === 'shadyside' && provider.zip !== '15232') continue;
            if (location === 'presby' && provider.zip !== '15213') continue;

            // Match name criteria
            if (!provider.lastname.toUpperCase().includes(lastNameUpper)) continue;
            if (firstName && !provider.firstname.toUpperCase().includes(firstNameUpper)) continue;

            matches.push({
              npi,
              ...provider
            });
          }
        } catch (error) {
          console.error(`Error processing ${fileName}:`, error);
        }
      }

      return matches;
    }

    function displayResults(providers) {
      loadingDiv.style.display = 'none';
      lookupButton.disabled = false;

      if (providers.length === 0) {
        resultsDiv.innerHTML = '<p>No providers found matching your criteria.</p>';
        return;
      }

      resultsDiv.innerHTML = `
        <h3>Found ${providers.length} Provider${providers.length === 1 ? '' : 's'}</h3>
      `;

      providers.forEach(provider => {
        const card = document.createElement('div');
        card.className = 'provider-card';
        card.innerHTML = `
          <strong>${provider.lastname}, ${provider.firstname}${provider.mi ? ` ${provider.mi}` : ''}</strong><br>
          ${provider.specialty}<br>
          ${provider.city}, ${provider.state} ${provider.zip}<br>
          NPI: ${provider.npi}
        `;
        card.onclick = () => lookupByNPI(provider.npi);
        resultsDiv.appendChild(card);
      });
    }

    async function lookupByNPI(npi, locationFilter) {
      // First find provider info in expanded index
      const providerInfo = await findProviderInIndex(npi);
      
      if (!providerInfo) {
        resultsDiv.innerHTML = `<p>No provider found with NPI ${npi}.</p>`;
        loadingDiv.style.display = 'none';
        lookupButton.disabled = false;
        return;
      }

      // Apply location filter if specified
      if (locationFilter === 'shadyside' && providerInfo.zip !== '15232') {
        resultsDiv.innerHTML = `<p>Provider not found at Shadyside Hospital.</p>`;
        loadingDiv.style.display = 'none';
        lookupButton.disabled = false;
        return;
      }

      if (locationFilter === 'presby' && providerInfo.zip !== '15213') {
        resultsDiv.innerHTML = `<p>Provider not found at Presbyterian Hospital.</p>`;
        loadingDiv.style.display = 'none';
        lookupButton.disabled = false;
        return;
      }

      // Display provider info
      displayProviderInfo(providerInfo);

      // Fetch and display procedures
      const procedures = await fetchProviderProcedures(npi, providerInfo.chunk);
      displayProcedures(procedures);

      loadingDiv.style.display = 'none';
      lookupButton.disabled = false;
    }

    async function findProviderInIndex(npi) {
      for (const fileName of indexFiles) {
        try {
          const response = await fetch(`${GITHUB_BASE_URL_INDEX}${fileName}`);
          if (!response.ok) continue;

          const data = await response.json();
          if (data[npi]) return data[npi];
        } catch (error) {
          console.error(`Error reading ${fileName}:`, error);
        }
      }
      return null;
    }

    function displayProviderInfo(provider) {
      providerInfoDiv.innerHTML = `
        <h3>Provider Information</h3>
        <p>
          <strong>${provider.lastname}, ${provider.firstname}${provider.mi ? ` ${provider.mi}` : ''}</strong><br>
          ${provider.specialty}<br>
          ${provider.city}, ${provider.state} ${provider.zip}
        </p>
      `;
      providerInfoDiv.style.display = 'block';
    }

    // Rest of the code (fetchProviderProcedures, displayProcedures, etc.) remains the same
    </script>
</body>
</html>
